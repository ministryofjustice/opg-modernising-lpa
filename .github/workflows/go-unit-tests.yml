name: "[Job] Run Go unit tests and Push coverage reports to Codecov"

on:
  workflow_call:
    inputs:
      tag:
        description: 'Tag for docker image'
        required: true
        type: string
      commit_sha:
        description: 'Latest commit SHA that triggered the workflow'
        required: true
        type: string
      branch_name:
        description: 'The Git branch name associated with the workflow'
        required: true
        type: string
    secrets:
      pact_broker_password:
        description: 'Password for central OPG pact broker'
        required: true

jobs:
  run:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v3
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: '^1.20'
      - name: Run tests and generate coverage report
        run: |
          go test ./... -race -covermode=atomic -coverprofile=coverage.out
      - name: Publish pacts
        run: |
          pact-broker publish ./pacts/modernising-lpa-data-lpa-uid.json \
            --consumer-app-version ${{ inputs.commit_sha }} \
            --branch ${{ inputs.branch_name }} \
            --tag ${{ inputs.docker_tag }} \
            --broker-base-url https://pact-broker.api.opg.service.justice.gov.uk \
            --broker-username admin \
            --broker-password ${{ secrets.pact_broker_password }}
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          flags: unittests
