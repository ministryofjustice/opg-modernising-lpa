name: "[Job] Run Go unit tests and Push coverage reports to Codecov"

on:
  workflow_call:
    inputs:
      tag:
        description: 'Tag for docker image'
        required: true
        type: string
      branch:
        description: 'The branch the workflow relates to'
        required: true
        type: string
      commit_sha:
        description: 'The commit SHA the workflow relates to'
        required: true
        type: string
    secrets:
      pact_broker_password:
        description: 'Password for central OPG pact broker'
        required: true

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '^1.20'

      - name: Set Pact Standalone version
        run: |
          echo "pact_version=1.88.82" >> $GITHUB_ENV

      - name: Cache Pact
        id: cache-pact
        uses: actions/cache@v3
        with:
          path: ./pact/
          key: ${{ runner.os }}-pact-${{ env.pact_version }}

      - name: Add Pact to Path
        if: steps.cache-pact.outputs.cache-hit == 'true'
        run: |
          echo "$PWD/pact/bin" >> $GITHUB_PATH

      - name: Download pact tools
        if: steps.cache-pact.outputs.cache-hit != 'true'
        run: |
          curl -LO https://github.com/pact-foundation/pact-ruby-standalone/releases/download/v${{ env.pact_version }}/pact-${{ env.pact_version }}-linux-x86_64.tar.gz
          tar xzf pact-${{ env.pact_version }}-linux-x86_64.tar.gz
          echo "$PWD/pact/bin" >> $GITHUB_PATH

      - name: Run tests and generate coverage report
        run: |
          mkdir -p ./coverage/cmd ./coverage/internal
          go test -cover ./internal/... -args -test.gocoverdir="$PWD/coverage/cmd"
          go test -cover ./internal/... -args -test.gocoverdir="$PWD/coverage/internal"
          go tool covdata textfmt -i=./coverage/internal,./coverage/cmd -o ./coverage/coverage_combined.out

      - name: Publish pacts
        run: |
          pact-broker publish ./internal/uid/pacts/modernising-lpa-data-lpa-uid.json \
            --consumer-app-version ${{ inputs.commit_sha }} \
            --branch ${{ inputs.branch }} \
            --tag ${{ inputs.tag }} \
            --broker-base-url https://pact-broker.api.opg.service.justice.gov.uk \
            --broker-username admin \
            --broker-password ${{ secrets.pact_broker_password }}

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          flags: unittests
          files: ./coverage/coverage_combined.out
