---
services:
  app:
    environment:
      - APP_PORT=8080
      - APP_PUBLIC_URL=https://secure-app:8443
      - ATTORNEY_START_URL=https://secure-app:8443/attorney-start
      - AUTH_REDIRECT_BASE_URL=https://secure-app:8443
      - AWS_ACCESS_KEY_ID=fakeKeyId
      - AWS_BASE_URL=http://localstack:4566
      - AWS_REGION=eu-west-1
      - AWS_SECRET_ACCESS_KEY=fakeAccessKey
      - CERTIFICATE_PROVIDER_START_URL=https://secure-app:8443/certificate-provider-start
      - CLIENT_ID=client-id-value
      - DONOR_START_URL=https://secure-app:8443/start
      - DEV_MODE=1
      - DYNAMODB_TABLE_LPAS=Lpas
      - DYNAMODB_TABLE_SESSIONS=Sessions
      - ENVIRONMENT=local
      - EVENT_BUS_NAME=default
      - GOVUK_NOTIFY_BASE_URL=http://mock-notify:8080
      - GOVUK_PAY_BASE_URL=http://mock-pay:8080
      - IDENTITY_URL=http://mock-onelogin:8080
      - ISSUER=http://mock-onelogin:8080
      - LPA_STORE_BASE_URL=http://mock-lpa-store:8080
      - LPA_STORE_SECRET_ARN=lpa-store-jwt-secret-key
      - ONELOGIN_URL=https://home.integration.account.gov.uk
      - ORDNANCE_SURVEY_BASE_URL=http://mock-os-api:8080
      - SCHEDULED_RUNNER_PERIOD=1m
      - S3_UPLOADS_KMS_KEY_ALIAS=alias/custom-key
      - SEARCH_ENDPOINT=http://my-domain.eu-west-1.opensearch.localhost.localstack.cloud:4566
      - SEARCH_INDEXING_DISABLED=0
      - SEARCH_INDEX_NAME=lpas
      - UID_BASE_URL=http://mock-uid:8080
      - UPLOADS_S3_BUCKET_NAME=evidence
      - USE_TEST_WITNESS_CODE=1

  # need to proxy app for https, otherwise need to remove Secure: true from cookies for cypress to run
  secure-app:
    build:
      context: ..
      dockerfile: docker/https-proxy/Dockerfile
    environment:
      TARGET: http://app:8080

  cypress:
    image: cypress/included:14.5.4
    depends_on:
      - secure-app
    environment:
      - CYPRESS_baseUrl=https://secure-app:8443
    working_dir: /e2e
    volumes:
      - ../:/e2e
